<!DOCTYPE html>
<!-- 网站主语言 -->
<html lang="zh-cn">
<head>
    <!-- 网站采用的字符编码 -->
    <meta charset="utf-8">
    <!-- 预留网站标题的位置 -->
    <title>{% block title %}{% endblock %}</title>
    <!-- 引入bootstrap的css文件 -->
    <link rel="stylesheet" href="../static/main.css">
    <script src="../static/main.js"></script>
    <link rel="stylesheet" href="../static/card.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <!-- 引入layer.js -->
    <link rel="stylesheet" href="../static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
</head>

<body class="{{ theme }}">
{% from 'header.html' import zytopbar %}
<!-- 调用topbar -->
{{ zytopbar() }}

<!-- 引入导航栏 -->
<!-- 定义导航栏 -->

<!-- 预留具体页面的位置 -->
<div class="container">
  <div class="row justify-content-md-center">

  <style>
    .carousel-inner .carousel-item img {
      max-height: 430px; /* 调整图片的最大高度 */
      object-fit: cover; /* 图片保持比例缩放，并填满容器 */
    }
  </style>
<div style="width: 1080px; height: 30px; background-color: transparent;">
  <a>公告:</a><span>{{ notice|safe }}</span>
  <div>
    <img src="{{ avatar_url }}" style="height: 35px; border-radius: 50%;" alt="">
    {% if userStatus %}
      <!-- 展示已登录的内容 -->
      <a>欢迎您，{{ username }}</a>   <a href="/media">媒体</a>  <a href="/logout">点击这里直接注销</a>　　<a href="/change-password">修改我的密码</a>
    {% else %}
      <!-- 展示未登录的内容 -->
      <a href="/login">需要登录</a>
    {% endif %}
  </div>
{% if Articles %}
      <!-- 展示已登录的内容 -->
      <br><span><span id="idSpan"></span>的文章</span>
    {% endif %}
<div id="changeCodeModal">
    <div class="modal-content">
      <h2>修改密码 - <span id="currentArticle"></span></h2>
        <span>不输入时保存可将密码重置为"0000"</span>
      <label for="newCodeInput">新的密码：</label>
      <input type="text" id="newCodeInput">
        <button id="backButton">取消</button>
      <button id="saveButton">保存</button>
    </div>
  </div>
{% for article in Articles %}
  <div class="col-md-6">
      <a href="{{ url_for('blog_detail', article=article) }}" class="card-link">
        <div class="card mb-4" style="background-color: transparent; width: 675px; height: 180px;">
          <div class="card-body" style="display: flex;">
            {% set i = range(1000)|random %}
            <!-- Check if the iteration is even -->
            {% if loop.index is even %}
              <h3 class="card-title">&nbsp;&nbsp;&nbsp;&nbsp;{{ article }}</h3>
              <img src="https://api.maho.cc/random-img/pc.php?i={{ i }}" alt="{{ article }}">
            {% else %}
              <img src="https://api.maho.cc/random-img/pc.php?i={{ i }}" alt="{{ article }}">
              <h3 class="card-title">&nbsp;&nbsp;&nbsp;&nbsp;{{ article }}</h3>
            {% endif %}
          </div>
        </div>
      </a><br/><a href="/edit/{{ article }}" style="color:greenyellow">编辑</a>
    <a href="#" data-article={{ article }} class='hidden121'>隐藏/取消隐藏此文章</a>
    <a href="#" data-article={{ article }} class='delete121' style="color:red">删除此文章</a>
    <a href="#" data-article="{{ article }}" class="changeCode" style="color:cadetblue">修改此文章密码</a>
    </div>
  {% endfor %}



<!-- 引入注脚 -->

<div>
    <br><br><br>
</div>
{% from 'footer.html' import zyfooter %}
<!-- 调用footer -->
{{ zyfooter() }}
</body>

</html>

<script>
    // 获取URL参数的函数
    function getParameterByName(name) {
        name = name.replace(/[\[\]]/g, "\\$&");
        var url = window.location.href;
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
        var results = regex.exec(url);
        if (!results) return '我';
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    // 在页面加载时获取URL参数id的值并显示
    window.onload = function() {
        var id = getParameterByName('id');
        var span = document.getElementById('idSpan');
        span.innerHTML = id;
    }
    // 设置隐藏/取消隐藏文章的请求参数
const hiddenLinks = document.querySelectorAll('a.hidden121');

// 为每个隐藏链接添加点击事件处理程序
hiddenLinks.forEach(link => {
  link.addEventListener('click', event => {
    event.preventDefault(); // 阻止默认链接行为

    // 获取链接上的 data-article 属性作为文章名
    const article = link.getAttribute('data-article');

    // 构建请求体
    const requestBody = JSON.stringify({ article });

    var confirmation = confirm('您正在尝试对文章进行一个操作，是否继续？');
    if (!confirmation) {
      // 用户点击了取消，终止本次请求
      return;
    }

    // 发起 POST 请求
    fetch('/hidden/article', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: requestBody
    })
      .then(response => response.json())
      .then(data => {
        if (data.deal === 'hide') {
          // 处理隐藏文章的响应
          console.log('文章已隐藏');
          alert('文章已隐藏');
        } else if (data.deal === 'unhide') {
          // 处理取消隐藏文章的响应
          console.log('文章已取消隐藏');
          alert('已经取消隐藏');
        } else if (data.deal === 'noAuth') {
          console.log('noAuth');
          alert('无权限操作');
        } else {
          // 处理其他响应
          console.log(data.message);
        }
      })
      .catch(error => {
        alert('请求出错');
        console.error('请求出错:', error);
      });
  });
});


//
const deleteLinks = document.querySelectorAll('a.delete121');

// 为每个隐藏链接添加点击事件处理程序
deleteLinks.forEach(link => {
  link.addEventListener('click', event => {
    event.preventDefault(); // 阻止默认链接行为

    // 获取链接上的 data-article 属性作为文章名
    const article = link.getAttribute('data-article');

    var confirmation = confirm('您正在尝试永久删除该文章！！！是否继续？');
    if (!confirmation) {
      // 用户点击了取消，终止本次请求
      return;
    }

    var confirmation0 = confirm('再次确认呢？是否继续？');
    if (!confirmation0) {
      // 用户点击了取消，终止本次请求
      return;
    }


    // 发起 POST 请求
    fetch(`/delete/${article}`, {
      method: 'POST'
    })
    .then(response => {
      if (response.ok) {
        // 成功删除文章
        alert('文章删除成功！');
        // 刷新页面或做其他处理
        location.reload();
      } else {
        // 删除文章失败
        alert('文章删除失败！');
      }
    })
    .catch(error => {
      // 请求出错
      alert('请求出错：' + error);
    });
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const changeCodeLinks = document.querySelectorAll('a.changeCode');

    changeCodeLinks.forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();

        const article = this.dataset.article;
        const changeCodeModal = document.getElementById('changeCodeModal');
        const currentArticle = document.getElementById('currentArticle');
        const newCodeInput = document.getElementById('newCodeInput');
        const saveButton = document.getElementById('saveButton');

        // Set the current article in the modal
        currentArticle.textContent = article;

        // Fill in the input with the current password
        newCodeInput.value = '';

        // Show the modal
        changeCodeModal.style.display = 'block';

        saveButton.addEventListener('click', function() {
          const newCode = newCodeInput.value;


          var confirmation = confirm('您正在尝试修改密码！！！是否继续？');
            if (!confirmation) {
            // 用户点击了取消，终止本次请求
             return;
            }
            var confirmation1 = confirm('密码修改后会在十分钟内生效，是否继续');
            if (!confirmation1) {
            // 用户点击了取消，终止本次请求
             return;
            }

          // Send POST request to the server
          fetch(`/change-article-pw/${article}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ NewPass: newCode, Article: article })
          })
          .then(response => response.text())
          .then(data => {
            if (data === 'success') {
              alert('密码修改成功');
            } else {
              alert('密码修改失败');
            }

            // Hide the modal
            changeCodeModal.style.display = 'none';
          });
        });
      });
    });
  });

  // 获取取消按钮
const cancelButton = document.getElementById("backButton");

// 点击取消按钮时触发的事件处理函数
cancelButton.addEventListener("click", function() {
    // 隐藏 changeCodeModal 元素
    const changeCodeModal = document.getElementById("changeCodeModal");
    changeCodeModal.style.display = "none";
});


</script>
<style>
    #changeCodeModal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    #changeCodeModal .modal-content {
      width: 100%;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }
  </style>